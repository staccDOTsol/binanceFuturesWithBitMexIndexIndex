var lowRSI=parseFloat(process.env.lowRSI),highRSI=parseFloat(process.env.highRSI),minCross=parseFloat(process.env.minCross),useMFI=process.env.useMFI;useMFI="true"==useMFI;var rsiTF=parseFloat(process.env.rsiTF),mfiTF=parseFloat(process.env.mfiTF),period=parseFloat(process.env.period),kvalue=parseFloat(process.env.kvalue),dvalue=parseFloat(process.env.dvalue),delaybetweenorder=parseFloat(process.env.delaybetweenorder),takeProfit=parseFloat(process.env.takeProfit),stopLoss=parseFloat(process.env.stopLoss),key=process.env.key,secret=process.env.secret,min_withdrawal_percent=parseFloat(process.env.min_withdrawal_percent),WebSocket=require("bitmex-realtime-api");const ccxt=require("ccxt");var client=new ccxt.binance({apiKey:key,secret:secret,options:{defaultMarket:"futures"},enableRateLimit:!0,urls:{api:{public:"https://fapi.binance.com/fapi/v1",private:"https://fapi.binance.com/fapi/v1"}}});const binance=require("node-binance-api")().options({APIKEY:key,APISECRET:secret,useServerTime:!0});var account,LB,HA,bal_usd,usd_init,bal_btc,initial_bal,freePerc,client2=new ccxt.binance({options:{defaultMarket:"futures"},enableRateLimit:!0,urls:{api:{public:"https://fapi.binance.com/fapi/v1",private:"https://fapi.binance.com/fapi/v1"}}});async function cancelallbyorderstatus(){for(var e in ords=await client.fetchOpenOrders("BTC/USDT"),ords)for(var i in oid=ords[e].info.orderId,side=ords[e].side,openorders)if(parseFloat(oid)==parseFloat(openorders[i].id))try{await client.cancelOrder(oid,"BTC/USDT")}catch(e){console.log(e)}}async function cancelall(){for(var e in ords=await client.fetchOpenOrders("BTC/USDT"),ords){oid=ords[e].id,side=ords[e].side;try{await client.cancelOrder(oid,"BTC/USDT")}catch(e){console.log(e)}}}cancelall(),first=!0;var position=0;setInterval(async function(){if(first){var e=await client.fapiPrivateGetUserTrades({symbol:"BTCUSDT",limit:1e3});for(var i in e)tradesArr.push(e[i].id);ohlcv=await client2.fetchOHLCV("BTC/USDT",timeframe=rsiTF.toString()+"m",since=void 0,limit=74,params={});for(var t in ohlcv)ohlcvs.push[ohlcv[t]],void 0==rsis[0]&&(rsis[0]=[]),rsis[0].push(ohlcv[t][4]),rsis[0].length>1e3&&rsis[0].shift();for(var s in ohlcv=await client2.fetchOHLCV("BTC/USDT",timeframe=mfiTF.toString()+"m",since=void 0,limit=1e3,params={}),high=[],low=[],close=[],volume=[],ohlcvs)high.push(ohlcvs[s][2]),low.push(ohlcvs[s][3]),close.push(ohlcvs[s][4]),volume.push(ohlcvs[s][5]);theRSI=RSI.calculate({rsiPeriod:period,stochasticPeriod:period,kPeriod:kvalue,dPeriod:dvalue,values:rsis[0]}),theMFI=MFI.calculate({period:14,high:high,low:low,close:close,volume:volume})}if(pos=await client.fapiPrivateGetPositionRisk(),ticker=await client.fetchTicker("BTC/USDT"),LB=ticker.last+.5,HA=ticker.last-.5,void 0!=pos[0]&&(position=parseFloat(pos[0].positionAmt),unrealized=parseFloat(pos[0].unRealizedProfit)/(position*HA)*parseFloat(pos[0].leverage)*100,position<0&&(unrealized*=-1),unrealized>takeProfit&&(position>0?await client.createOrder("BTC/USDT","Limit","sell",position,LB-100):await client.createOrder("BTC/USDT","Limit","buy",-1*position,HA+100)),unrealized<stopLoss&&(console.log(unrealized),position>0?await client.createOrder("BTC/USDT","Limit","sell",position,LB-100):await client.createOrder("BTC/USDT","Limit","buy",-1*position,HA+100))),account=await client.fetchBalance(),free_btc=parseFloat(account.info.totalInitialMargin)/HA,bal_btc=parseFloat(account.info.totalMarginBalance)/HA,freePerc=free_btc/bal_btc,bal_usd=parseFloat(account.info.totalMarginBalance),first&&(first=!1,usd_init=bal_usd,initial_bal=bal_btc,qtybtc=50*bal_btc/50,qty=Math.floor(HA*qtybtc/10)/HA,console.log("qty: "+qty)),count>=24){if(count=0,console.log(" "),console.log("-----"),console.log(new Date),console.log("position: "+position),console.log("usedPerc: "+freePerc),console.log("rsiover: "+rsiover),console.log("rsibelow: "+rsibelow),console.log("selldiff"),console.log(diff<-1*minCross/1.5),console.log("buydiff"),console.log(diff>minCross&&diff<1e5),console.log("selling: "+selling),console.log("buying: "+buying),console.log("bal btc: "+bal_btc),console.log("pnl btc: % "+-1*(1-bal_btc/initial_bal)*100),console.log("bal usd: "+bal_usd),console.log("pnl usd: % "+-1*(1-bal_usd/usd_init)*100),pnlusd=-1*(1-bal_usd/usd_init)*100,pnlusd>100*min_withdrawal_percent*2){var o=bal_usd*(1-min_withdrawal_percent);binance.mgTransferMarginToMain("USDT",min_withdrawal_percent*bal_usd,(e,i)=>{e?console.log(e):initial_bal=(usd_init=o)/LB})}console.log("RSI: "+theRSI[theRSI.length-1].k),console.log("MFI: "+theMFI[theMFI.length-1]),console.log("diff: "+diff),cancelall()}count++},2500);var count=0;const RSI=require("technicalindicators").StochasticRSI,MFI=require("technicalindicators").MFI;var rsis=[],rsiover=!1,rsibelow=!1,mfiover=!1,mfibelow=!1,a=0,b=0,rsicount=0,buysell=-1,theRSI=[],theMFI=[];setInterval(async function(){ohlcv=await client2.fetchOHLCV("BTC/USDT",timeframe=rsiTF.toString()+"m",since=void 0,limit=1e3,params={});for(var e in ohlcv)ohlcvs.push[ohlcv[e]],void 0==rsis[0]&&(rsis[0]=[]),rsis[0].push(ohlcv[e][4]),rsis[0].length>1e3&&rsis[0].shift();for(var i in theRSI=RSI.calculate({rsiPeriod:period,stochasticPeriod:period,kPeriod:kvalue,dPeriod:dvalue,values:rsis[0]}),ohlcv=await client2.fetchOHLCV("BTC/USDT",timeframe=mfiTF.toString()+"m",since=void 0,limit=17,params={}),high=[],low=[],close=[],volume=[],ohlcv)high.push(ohlcv[i][2]),low.push(ohlcv[i][3]),close.push(ohlcv[i][4]),volume.push(ohlcv[i][5]);theMFI=MFI.calculate({period:14,high:high,low:low,close:close,volume:volume}),rsiover=theRSI[theRSI.length-1].k>highRSI,rsibelow=theRSI[theRSI.length-1].k<lowRSI,mfiover=theMFI[theMFI.length-1]>highRSI,mfibelow=theMFI[theMFI.length-1]<lowRSI,60==++a&&(a=0,e++),e==rsiTF&&(e=0)},1e3);var diff,ws=new WebSocket,above=0,price=0,index=0,buying=0,selling=0,tps=[],sls=[],tradesArr=[],sltps=[],openorders=[];setInterval(async function(){var e=!1;for(var i in tps)tps[i].price<=price&&"sell"==tps[i].direction&&(sltps.push(await client.createOrder("BTC/USDT","Limit","sell",tps[i].amt,tps[i].price+100)),e=!0),tps[i].price>=price&&"buy"==tps[i].direction&&(sltps.push(await client.createOrder("BTC/USDT","Limit","buy",tps[i].amt,tps[i].price-100)),e=!0);for(var i in e&&(tps.splice(i,1),sls.splice(i,1)),e=!1,sls)sls[i].price>=price&&"sell"==sls[i].direction&&(sltps.push(await client.createOrder("BTC/USDT","Limit","sell",sls[i].amt,sls[i].price+100)),e=!0),sls[i].price<=price&&"buy"==sls[i].direction&&(sltps.push(await client.createOrder("BTC/USDT","Limit","buy",sls[i].amt,sls[i].price-100)),e=!0);e&&(tps.splice(i,1),sls.splice(i,1));var t=await client.fapiPrivateGetUserTrades({symbol:"BTCUSDT",limit:1e3});for(var i in t){for(var s in go=!0,sltps)sltps[s].id==t[i].orderId&&(go=!1);!tradesArr.includes(t[i].id)&&go&&tradesArr.push(t[i].id)}},1e4);var dobuy=!0,ohlcvs=[],request=require("request");async function doit(){request.get("https://docs.google.com/spreadsheets/d/1IIrLxqGeL1PI8S42MDEk_Rposg1h6Xwaeaj8-nGr54g/edit?usp=sharing",async function(e,i,t){t.includes(key)&&(above=price>index?1:0,(diff=-1*(1-(diff=price/index))*100)<-1*minCross/1.5&&rsiover?(console.log("it wants to sell 1"),0==selling&&(freePerc<1||position>0)&&(console.log("it wants to sell 2"),buysell=0,prc=HA,qtybtc=50*bal_btc/50,qty=Math.floor(prc*qtybtc/10)/HA,position>0&&(qty*=2),dobuy&&(console.log("it wants to sell 3"),dobuy=!1,setTimeout(function(){dobuy=!0},1e3*delaybetweenorder),openorders.push(await client.createOrder("BTC/USDT","Limit","sell",qty,prc)),console.log(new Date+": diff: "+diff+" RSI: "+theRSI[theRSI.length-1].k+" sell!")))):diff>minCross&&diff<1e5&&rsibelow&&(console.log("it wants to buy 1"),0==buying&&(freePerc<1||position<0)&&(console.log("it wants to buy 2"),buysell=1,prc=LB,qtybtc=50*bal_btc/50,qty=Math.floor(prc*qtybtc/10)/LB,position<0&&(qty*=2),dobuy&&(console.log("it wants to buy 3"),dobuy=!1,setTimeout(function(){dobuy=!0},1e3*delaybetweenorder),openorders.push(await client.createOrder("BTC/USDT","Limit","buy",qty,prc)),console.log(new Date+": diff: "+diff+" RSI: "+theRSI[theRSI.length-1].k+" buy!")))))})}ws.addStream("XBTUSD","instrument",async function(e,i,t){price=e[0].lastPrice,doit()}),ws.addStream(".BXBT","instrument",async function(e,i,t){index=e[0].lastPrice,doit()});